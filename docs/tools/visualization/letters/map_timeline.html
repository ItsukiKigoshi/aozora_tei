---
layout: default
---

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
            integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script src="./assets/thirdparty/CETEI/js/CETEI.js"></script>
    <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="./assets/js/leaflet.polylineDecorator.js"></script>
    <script src="./assets/js/leaflet.timeline.js"></script>
    <style>
        /*
      * You could style the timeline however you like, but we just make it wider here.
      */
        .leaflet-left {
            width: 100%;
        }
    </style>
    <script>
         
        var map;

        var polygons = {
            "type": "FeatureCollection",
            "features": []
        };

        var points = {
            "type": "FeatureCollection",
            "features": []
        };

        function main(url) {

            new CETEI().getHTML5(url, function (data) {
                var roadlatlons = []

                var obj = {}

                var correspactions = $(data).find("tei-correspaction")

                

                for (var j = 0; j < correspactions.length; j++) {
                    var correspaction = correspactions[j]
                    var persName = null;
                    if ($(correspaction).find("tei-persname") != null) {
                        persName = $(correspaction).find("tei-persname")[0]
                        persName = $(persName).text()
                    }

                    var placeName = null;
                    if ($(correspaction).find("tei-placename") != null) {
                        placeName = $(correspaction).find("tei-placename")[0]
                        placeName = $(placeName).text()
                    }

                    var date = null;
                    if ($(correspaction).find("tei-date") != null) {
                        date = $(correspaction).find("tei-date")[0]
                        date = $(date).attr("when")
                    }

                    var type = $(correspaction).attr("type")

                    var tmp = {}
                    tmp.persname = persName
                    tmp.placename = placeName
                    tmp.date = date

                    obj[type] = tmp

                    

                    var geo = $(correspaction).find("tei-geo")[0]
                    var latlng = $(geo).text().split(" ")
                    roadlatlons.push([Number(latlng[0]), Number(latlng[1])])

                    var popup = L.popup().setContent(placeName);
                    //L.marker([Number(latlng[0]), Number(latlng[1])]).bindPopup(popup).bindTooltip(placeName).addTo(map);

                    
                }

                var date = null
                for(var type in obj){
                    if(obj[type].date){
                        date = obj[type].date
                    }
                }

                if(date != null){

                    var start = date
                    var end = new Date(start)
                    end = new Date(end.setDate(end.getDate() + 30))
                    end = getNowYMD(end)

                    var arrow = {
                        "type": "Feature",
                        "properties": {
                            "start": start,
                            "end": end
                        },
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [roadlatlons[0][1], roadlatlons[0][0]],
                                [roadlatlons[1][1], roadlatlons[1][0]]
                            ]
                            
                        }
                    }

                    polygons.features.push(arrow)

                    for(var i = 0 ; i < 2; i++){

                        var type = i == 0 ? "sent" : "received";

                        var point = {
                            "type": "Feature",
                            "properties": {
                                "start": start,
                                "end": end,
                                "name": obj[type].placename
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [
                                    roadlatlons[i][1], roadlatlons[i][0]
                                ]

                            }
                        }

                        points.features.push(point)
                    }
                }

                var tr = $("<tr>")
                $("#tbody").append(tr)

                var td = $("<td>")
                tr.append(td)
                td.append(obj.sent.persname)

                td = $("<td>")
                tr.append(td)
                td.append(obj.sent.placename)

                td = $("<td>")
                tr.append(td)
                td.append(obj.sent.date)

                //----------

                td = $("<td>")
                tr.append(td)
                td.append(obj.received.persname)

                td = $("<td>")
                tr.append(td)
                td.append(obj.received.placename)

                td = $("<td>")
                tr.append(td)
                td.append(obj.received.date)

                //---------

                td = $("<td>")
                tr.append(td)

                var a = $("<a>")
                td.append(a)
                a.attr("href", url.replace("raw.githubusercontent.com", "github.com").replace("/master/", "/blob/master/"))
                a.attr("target", "_blank")

                var img = $("<img>")
                a.append(img)
                img.attr("src", "https://tei-c.org/Vault/MembersMeetings/2013/wp-content/themes/atahualpa/images/header/TEIlogo.png")
                img.attr("width", "45px")

            })

        }

        function start(){

            console.log(points)

            var slider = L.timelineSliderControl({
                formatOutput: function (date) {
                    return moment(date).format("YYYY-MM-DD");
                }
            });
            map.addControl(slider);

            var polygonTimeline = L.timeline(polygons);
            polygonTimeline.addTo(map);

            var pointTimeline = L.timeline(points);
            pointTimeline.addTo(map);

            slider.addTimelines(polygonTimeline, pointTimeline);

            $("#btn").hide()
        }

        function init() {
            map = L.map('mapcontainer', { zoomControl: false });

            var mpoint = [35.8627, 139.6072];
            map.setView(mpoint, 7);


            L.tileLayer('http://tile.openstreetmap.jp/{z}/{x}/{y}.png',
                { attribution: "<a href='http://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors" }).addTo(map);


            $.getJSON("https://raw.githubusercontent.com/TEI-EAJ/aozora_tei/master/docs/tools/visualization/letters/config.json", function (data) {
                var urls = data;
                for (var i = 0; i < urls.length; i++) {
                    var url = urls[i]
                    main(url)
                }
            })

            
        }

        function getNowYMD(dt) {
                var y = dt.getFullYear();
                var m = ("00" + (dt.getMonth() + 1)).slice(-2);
                var d = ("00" + dt.getDate()).slice(-2);
                var result = y + "-" + m + "-" + d;
                return result;
            }
    </script>
</head>

<body onload="init()">
    <div class="container my-5">
        <h2>書簡の送受信地の可視化（Timeline）</h2>
        <div id="mapcontainer" class="mt-5" style="width: 100%; height: 600px;"></div>
        <button onclick="start()" class="mt-2 btn btn-primary" id="btn"><i class="fas fa-play"></i></button>
        <table class="table mt-5" style="background-color: white;">
            <thead>
                <tr>
                    <th>送信者</th>
                    <th>送信場所</th>
                    <th>送信日時</th>
                    <th>受信者</th>
                    <th>受信場所</th>
                    <th>受信日時</th>
                    <th>リンク</th>
                </tr>
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>
    </div>
</body>

</html>