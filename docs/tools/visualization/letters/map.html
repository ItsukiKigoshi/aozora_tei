---
layout: default
---

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />


    <script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="./assets/js/leaflet.polylineDecorator.js"></script>

    <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/storyjs-embed.js"></script>

    <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/site.js"></script>

    <link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" />
    <script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script>

        var map;

        var data_timeline = []

        function main(url) {

            // Load the xml file using ajax 
            $.ajax({
                async: false,
                type: "GET",
                url: url,
                dataType: "xml",
                success: function (data) {

                    var roadlatlons = []

                    var obj = {}

                    var correspactions = $(data).find("correspAction")
                    for (var j = 0; j < correspactions.length; j++) {
                        var correspaction = correspactions[j]
                        var persName = null;
                        if ($(correspaction).find("persName") != null) {
                            persName = $(correspaction).find("persName")[0]
                            persName = $(persName).text()
                        }

                        var placeName = null;
                        if ($(correspaction).find("placeName") != null) {
                            placeName = $(correspaction).find("placeName")[0]
                            placeName = $(placeName).text()
                        }

                        var date = null;
                        if ($(correspaction).find("date") != null) {
                            date = $(correspaction).find("date")[0]
                            date = $(date).attr("when")
                        }

                        var type = $(correspaction).attr("type")

                        var tmp = {}
                        tmp.persname = persName
                        tmp.placename = placeName
                        tmp.date = date

                        obj[type] = tmp

                        var geo = $(correspaction).find("geo")[0]
                        var latlng = $(geo).text().split(" ")
                        roadlatlons.push([Number(latlng[0]), Number(latlng[1])])

                        var popup = L.popup().setContent(placeName);
                        L.marker([Number(latlng[0]), Number(latlng[1])]).bindPopup(popup).bindTooltip(placeName).addTo(map);
                    }

                    //polylineオブジェクトを作成して地図に追加
                    var arrow = L.polyline(roadlatlons, { color: 'blue', weight: 5, "opacity": 0.6 }).addTo(map);
                    var arrowHead = L.polylineDecorator(arrow, {
                        patterns: [
                            { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 15, polygon: false, pathOptions: { stroke: true, color: 'blue', weight: 5, "opacity": 0.6 } }) }
                        ]
                    }).addTo(map);

                    var tr = $("<tr>")
                    $("#tbody").append(tr)

                    var td = $("<td>")
                    tr.append(td)
                    td.append(obj.sent.persname)

                    td = $("<td>")
                    tr.append(td)
                    td.append(obj.sent.placename)

                    td = $("<td>")
                    tr.append(td)
                    td.append(obj.sent.date)

                    //----------

                    td = $("<td>")
                    tr.append(td)
                    td.append(obj.received.persname)

                    td = $("<td>")
                    tr.append(td)
                    td.append(obj.received.placename)

                    td = $("<td>")
                    tr.append(td)
                    td.append(obj.received.date)

                    //---------

                    td = $("<td>")
                    tr.append(td)

                    var a = $("<a>")
                    td.append(a)
                    a.attr("href", url.replace("raw.githubusercontent.com", "github.com").replace("/master/", "/blob/master/"))
                    a.attr("target", "_blank")

                    var img = $("<img>")
                    a.append(img)
                    img.attr("src", "https://tei-c.org/Vault/MembersMeetings/2013/wp-content/themes/atahualpa/images/header/TEIlogo.png")
                    img.attr("width", "45px")

                    if (obj.sent.date) {
                        var obj_timeline = {}
                        obj_timeline.date = obj.sent.date
                        obj_timeline.title = "送信者: " + obj.sent.persname + ", 受信者: " + obj.received.persname
                        data_timeline.push(obj_timeline)
                    }

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(url);
                }
            });

        }

        function init() {
            map = L.map('mapcontainer', { zoomControl: false });

            var mpoint = [35.8627, 139.6072];
            map.setView(mpoint, 7);


            L.tileLayer('http://tile.openstreetmap.jp/{z}/{x}/{y}.png',
                { attribution: "<a href='http://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors" }).addTo(map);


            $.getJSON("https://raw.githubusercontent.com/TEI-EAJ/aozora_tei/master/docs/tools/visualization/letters/config.json", function (data) {
                var urls = data;
                for (var i = 0; i < urls.length; i++) {
                    var url = urls[i]
                    main(url)
                }

                $('#table').DataTable();

                var dataObject = arrangeJson4Timeline2(data_timeline);

                //空じゃなければ
                if (dataObject.timeline.date.length != 0) {
                    createStoryJS({
                        type: 'timeline',
                        width: '100%',
                        height: '600',
                        source: dataObject,
                        embed_id: 'my-timeline',
                        lang: 'ja'
                    });
                }

            })
        }

        function arrangeJson4Timeline2(data) {

            var result = new Object();

            var timeline = new Object();
            result["timeline"] = timeline;

            timeline["headline"] = "";
            timeline["type"] = "default";
            timeline["text"] = "";

            var array = new Array();
            timeline["date"] = array;

            for (var i = 0; i < data.length; i++) {

                var obj = data[i];

                var title = obj.title

                var bd = obj.date
                var dd = obj.date

                //--------------------------------

                var event = new Object();//一要素
                array.push(event);

                //--------------------------------

                event["startDate"] = bd.replace(/-/g, ",");
                event["endDate"] = dd.replace(/-/g, ",");

                //---------------------------------

                event["headline"] = title;

                //----------------------------------

                //表示情報
                var div = $("<div>");

                //----------------------------------

                var thumb = obj.pthumbnail;
                if (thumb != null) {

                    //ASSET

                    var thumb = thumb.value;

                    var asset = new Object();


                    asset.media = thumb;
                    asset.thumbnail = thumb;

                    event["asset"] = asset;

                }

                var spanStr = $('<div>').append(div.clone()).html();
                event["text"] = spanStr;

            }

            return result;
        }

    </script>
</head>

<body onload="init()">
    <div class="container my-5">
        <h2>書簡の送受信の可視化</h2>
        <div id="mapcontainer" class="mt-5" style="width: 100%; height: 600px;"></div>

        <div class="my-5">
            <div id="my-timeline"></div>
        </div>

        <table class="table mt-5" style="background-color: white;" id="table">
            <thead>
                <tr>
                    <th>送信者</th>
                    <th>送信場所</th>
                    <th>送信日時</th>
                    <th>受信者</th>
                    <th>受信場所</th>
                    <th>受信日時</th>
                    <th>リンク</th>
                </tr>
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>
    </div>
</body>

</html>